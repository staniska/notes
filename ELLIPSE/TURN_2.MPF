PARAMS

R10=90/3 ;Шаг угла

G0 X=R20*2+10 Z=-R21 ;Выход на начальную точку с безопасным расстоянием
G1 X=R20*2  ;Подход к контуру
R1=R10 ; Текущий угол
;Положение предыдущей точки относительно центра эллипса
R2=R20 ; X на сторону
R3=0 ; Z
CYCLE:

;Радиус и координаты для текущего угла
R4=R20*R21/SQRT(POT(R20*SIN(R1))+POT(R21*COS(R1))) ;Радиус
R5=R4*SIN(R1) ;Координата Z без смещения
R6=R4*COS(R1) ;Координата Х в радиальном выражении

R7=R1-R10/2 ;Средний угол между предыдущим и текущим проходом
;Радиус и координаты для промежуточного угла
R4=R20*R21/SQRT(POT(R20*SIN(R7))+POT(R21*COS(R7))) ;Радиус
R8=R4*SIN(R7) ;Координата Z без смещения
R9=R4*COS(R7) ;Координата Х в радиальном выражении

;R10 уже занят для шага угла
;Координаты средней точки на первом отрезке относительно центра эллипса
R11=(R2+R9)/2  ;X
R12=(R3+R8)/2  ;Z
;Координаты средней точки на втором отрезке
R13=(R6+R9)/2  ;X
R14=(R5+R8)/2  ;Z
;угловой коэффициент для первого отрезка
;   K=(Y2-Y1)/(X2-X1)
R15=(R8-R3)/(R9-R2)
;угловой коэффициент для второго отрезка
R16=(R8-R5)/(R9-R6)
;угловой коэффициент нормали к первому отрезку
;K=-1/K(отрезка)
R17=-1/R15
;угловой коэффициент нормали ко второму отрезку
R18=-1/R16

;R20 и R21 уже заняты параметрами эллипса. R19 не использую для удобства

;член b уравнения прямой y=kx+b для нормали к первому отрезку
;b=-k*X+Y
R22=-R17*R11+R12
;член b уравнения прямой y=kx+b для нормали ко второму отрезку
R23=-R18*R13+R14
;Решаем систему линейных уравнений для нахождения пересечения двух нормалей
; координаты точки пересечения являются центром искомой дуги
;  /Y=K1*X+B1
;  \Y=K2*X+B2
;  из этой системы X=(B2-B1)/(K1-K2)
R24=(R23-R22)/(R17-R18)
; Y находим из первого уравнения
R25=R17*R24+R22

;Если поставить < то увидим дуги
;Если поставить > то увидим отрезки и нормали
IF (1<0)
  G1 X=R11*2 Z=R12-R21  ;Средняя точка первого отрезка
  X=R24*2 Z=R25-R21     ;Цетр дуги
  X=R11*2 Z=R12-R21     ;Возвращаемся на среднюю точку
  X=R9*2 Z=R8-R21       ;Промежуточная точка на эллипсе
  X=R13*2 Z=R14-R21     ;Средняя точка второго отрезка
  X=R24*2 Z=R25-R21     ;Цетр дуги
  X=R13*2 Z=R14-R21     ;Возвращаемся на среднюю точку
  X=R6*2 Z=R5-R21       ;Конечная точка
ELSE
  G2 X=R6*2 Z=R5-R21 I=AC(R24*2) K=AC(R25-R21)
ENDIF

;Сохраняем координаты конечной точки для текущего угла в R2 и R3 для следующего расчета
R2=R6
R3=R5

;Зацикливание
R1=R1+R10
IF R1<=90 GOTOB CYCLE
G0 Z=IC(100)

M30
